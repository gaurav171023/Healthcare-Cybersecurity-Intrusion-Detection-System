{% extends "base.html" %}

{% block title %}Detection Results - Healthcare Cybersecurity{% endblock %}

{% block content %}
<div class="container">
    <!-- Results Header -->
    <div class="row mb-4">
        <div class="col-12 text-center">
            <div class="{% if prediction == 'Normal' %}prediction-normal{% else %}prediction-attack{% endif %} 
                        p-5 rounded-3 shadow-lg">
                <div class="display-1 mb-3">
                    {% if prediction == 'Normal' %}
                        <i class="fas fa-shield-alt text-white"></i>
                    {% else %}
                        <i class="fas fa-exclamation-triangle text-white"></i>
                    {% endif %}
                </div>
                <h1 class="display-4 fw-bold text-white mb-3">
                    {% if prediction == 'Normal' %}
                        Network Traffic is NORMAL
                    {% else %}
                        THREAT DETECTED: {{ prediction }}
                    {% endif %}
                </h1>
                <p class="lead text-white mb-4">
                    {% if prediction == 'Normal' %}
                        No malicious activity detected in the analyzed network traffic.
                    {% else %}
                        Potential security threat identified. Immediate action recommended.
                    {% endif %}
                </p>
                
                <!-- Confidence Score -->
                <div class="row justify-content-center">
                    <div class="col-md-6">
                        <div class="bg-white bg-opacity-25 p-4 rounded-3">
                            <h5 class="text-white mb-3">
                                <i class="fas fa-bullseye me-2"></i>Confidence Score
                            </h5>
                            <div class="progress mb-2" style="height: 20px; background: rgba(255,255,255,0.3);">
                                <div class="progress-bar bg-white" 
                                     style="width: {{ confidence }}%;">
                                    <strong class="text-dark">{{ confidence }}%</strong>
                                </div>
                            </div>
                            <small class="text-white">
                                {% if confidence >= 90 %}
                                    Very High Confidence
                                {% elif confidence >= 75 %}
                                    High Confidence
                                {% elif confidence >= 60 %}
                                    Moderate Confidence
                                {% else %}
                                    Low Confidence
                                {% endif %}
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Action Buttons -->
    <div class="row mb-4">
        <div class="col-12 text-center">
            <div class="btn-group" role="group">
                <a href="{{ url_for('predict') }}" class="btn btn-primary btn-lg">
                    <i class="fas fa-redo me-2"></i>Analyze Another
                </a>
                <a href="{{ url_for('dashboard') }}" class="btn btn-success btn-lg">
                    <i class="fas fa-tachometer-alt me-2"></i>Dashboard
                </a>
                <button class="btn btn-info btn-lg" onclick="generateReport()">
                    <i class="fas fa-download me-2"></i>Download Report
                </button>
                <button class="btn btn-warning btn-lg" data-bs-toggle="modal" data-bs-target="#detailsModal">
                    <i class="fas fa-info-circle me-2"></i>View Details
                </button>
            </div>
        </div>
    </div>
    
    <!-- Threat Information -->
    <div class="row">
        <div class="col-lg-8 mb-4">
            <div class="card shadow">
                <div class="card-header {% if prediction == 'Normal' %}bg-success{% else %}bg-danger{% endif %} text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        {% if prediction == 'Normal' %}
                            Normal Traffic Analysis
                        {% else %}
                            Threat Analysis: {{ prediction }}
                        {% endif %}
                    </h5>
                </div>
                <div class="card-body">
                    {% if prediction == 'Normal' %}
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle me-2"></i>
                            <strong>Good News!</strong> The analyzed network traffic appears to be legitimate and poses no security threat.
                        </div>
                        
                        <h6 class="fw-bold text-success mb-3">Why this traffic is considered normal:</h6>
                        <ul class="list-unstyled">
                            <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Standard connection patterns detected</li>
                            <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Normal byte transfer rates</li>
                            <li class="mb-2"><i class="fas fa-check text-success me-2"></i>No suspicious authentication attempts</li>
                            <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Legitimate service usage patterns</li>
                        </ul>
                        
                        <div class="mt-4">
                            <h6 class="fw-bold text-primary mb-3">Recommended Actions:</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="p-3 bg-light rounded">
                                        <i class="fas fa-eye text-info mb-2" style="font-size: 1.5rem;"></i>
                                        <h6 class="fw-bold">Continue Monitoring</h6>
                                        <small>Maintain regular traffic analysis</small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="p-3 bg-light rounded">
                                        <i class="fas fa-shield-alt text-success mb-2" style="font-size: 1.5rem;"></i>
                                        <h6 class="fw-bold">Maintain Security</h6>
                                        <small>Keep current security measures</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Security Alert!</strong> Potential {{ prediction.lower() }} detected in network traffic.
                        </div>
                        
                        {% if 'DoS' in prediction %}
                            <h6 class="fw-bold text-danger mb-3">DoS/DDoS Attack Characteristics:</h6>
                            <ul class="list-unstyled">
                                <li class="mb-2"><i class="fas fa-bomb text-danger me-2"></i>High volume of connection requests</li>
                                <li class="mb-2"><i class="fas fa-bomb text-danger me-2"></i>Abnormal traffic patterns</li>
                                <li class="mb-2"><i class="fas fa-bomb text-danger me-2"></i>Resource exhaustion attempts</li>
                                <li class="mb-2"><i class="fas fa-bomb text-danger me-2"></i>Service disruption indicators</li>
                            </ul>
                            
                            <div class="alert alert-warning">
                                <i class="fas fa-shield-alt me-2"></i>
                                <strong>Immediate Actions Required:</strong>
                                <ul class="mb-0 mt-2">
                                    <li>Implement rate limiting</li>
                                    <li>Block suspicious IP addresses</li>
                                    <li>Scale up resources if possible</li>
                                    <li>Contact network security team</li>
                                </ul>
                            </div>
                        {% elif 'Probe' in prediction %}
                            <h6 class="fw-bold text-warning mb-3">Probe Attack Characteristics:</h6>
                            <ul class="list-unstyled">
                                <li class="mb-2"><i class="fas fa-search text-warning me-2"></i>Port scanning activity</li>
                                <li class="mb-2"><i class="fas fa-search text-warning me-2"></i>Service enumeration attempts</li>
                                <li class="mb-2"><i class="fas fa-search text-warning me-2"></i>Vulnerability assessment patterns</li>
                                <li class="mb-2"><i class="fas fa-search text-warning me-2"></i>Reconnaissance behavior</li>
                            </ul>
                            
                            <div class="alert alert-warning">
                                <i class="fas fa-eye me-2"></i>
                                <strong>Recommended Actions:</strong>
                                <ul class="mb-0 mt-2">
                                    <li>Monitor source IP closely</li>
                                    <li>Review firewall rules</li>
                                    <li>Implement intrusion detection</li>
                                    <li>Log all connection attempts</li>
                                </ul>
                            </div>
                        {% elif 'R2L' in prediction %}
                            <h6 class="fw-bold text-info mb-3">Remote-to-Local Attack Characteristics:</h6>
                            <ul class="list-unstyled">
                                <li class="mb-2"><i class="fas fa-arrow-right text-info me-2"></i>Unauthorized access attempts</li>
                                <li class="mb-2"><i class="fas fa-arrow-right text-info me-2"></i>Remote login exploitation</li>
                                <li class="mb-2"><i class="fas fa-arrow-right text-info me-2"></i>Password attack patterns</li>
                                <li class="mb-2"><i class="fas fa-arrow-right text-info me-2"></i>Service exploitation attempts</li>
                            </ul>
                            
                            <div class="alert alert-danger">
                                <i class="fas fa-lock me-2"></i>
                                <strong>Critical Actions Required:</strong>
                                <ul class="mb-0 mt-2">
                                    <li>Change all passwords immediately</li>
                                    <li>Review user accounts</li>
                                    <li>Implement 2FA</li>
                                    <li>Audit system access logs</li>
                                </ul>
                            </div>
                        {% elif 'U2R' in prediction %}
                            <h6 class="fw-bold text-purple mb-3">User-to-Root Attack Characteristics:</h6>
                            <ul class="list-unstyled">
                                <li class="mb-2"><i class="fas fa-user-cog text-purple me-2"></i>Privilege escalation attempts</li>
                                <li class="mb-2"><i class="fas fa-user-cog text-purple me-2"></i>Root access exploitation</li>
                                <li class="mb-2"><i class="fas fa-user-cog text-purple me-2"></i>System vulnerability abuse</li>
                                <li class="mb-2"><i class="fas fa-user-cog text-purple me-2"></i>Administrative bypass attempts</li>
                            </ul>
                            
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-circle me-2"></i>
                                <strong>Emergency Response Required:</strong>
                                <ul class="mb-0 mt-2">
                                    <li>Isolate affected systems immediately</li>
                                    <li>Review administrator accounts</li>
                                    <li>Audit system modifications</li>
                                    <li>Contact incident response team</li>
                                </ul>
                            </div>
                        {% endif %}
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Statistics Panel -->
        <div class="col-lg-4 mb-4">
            <div class="card shadow h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-bar me-2"></i>Detection Statistics
                    </h5>
                </div>
                <div class="card-body">
                    <div class="text-center mb-4">
                        <canvas id="confidenceChart" width="200" height="200"></canvas>
                    </div>
                    
                    <div class="row text-center">
                        <div class="col-6 mb-3">
                            <div class="p-2 bg-light rounded">
                                <h6 class="fw-bold text-primary mb-1">{{ confidence }}%</h6>
                                <small class="text-muted">Confidence</small>
                            </div>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="p-2 bg-light rounded">
                                <h6 class="fw-bold text-success mb-1">&lt;100ms</h6>
                                <small class="text-muted">Analysis Time</small>
                            </div>
                        </div>
                    </div>
                    
                    <h6 class="fw-bold text-primary mb-3">Model Information:</h6>
                    <ul class="list-unstyled">
                        <li class="mb-2">
                            <i class="fas fa-brain text-info me-2"></i>
                            <small>Ensemble ML Algorithm</small>
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-database text-success me-2"></i>
                            <small>Trained on 100K+ samples</small>
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-chart-line text-warning me-2"></i>
                            <small>99.8% Overall Accuracy</small>
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-clock text-primary me-2"></i>
                            <small>Real-time Analysis</small>
                        </li>
                    </ul>
                    
                    <div class="mt-4">
                        <h6 class="fw-bold text-success mb-3">
                            <i class="fas fa-history me-2"></i>Next Steps
                        </h6>
                        {% if prediction == 'Normal' %}
                        <div class="btn-group-vertical w-100">
                            <button class="btn btn-outline-primary btn-sm mb-2" onclick="scheduleMonitoring()">
                                <i class="fas fa-calendar me-1"></i>Schedule Monitoring
                            </button>
                            <button class="btn btn-outline-success btn-sm" onclick="shareResults()">
                                <i class="fas fa-share me-1"></i>Share Results
                            </button>
                        </div>
                        {% else %}
                        <div class="btn-group-vertical w-100">
                            <button class="btn btn-outline-danger btn-sm mb-2" onclick="alertTeam()">
                                <i class="fas fa-bell me-1"></i>Alert Security Team
                            </button>
                            <button class="btn btn-outline-warning btn-sm mb-2" onclick="blockTraffic()">
                                <i class="fas fa-ban me-1"></i>Block Source
                            </button>
                            <button class="btn btn-outline-info btn-sm" onclick="detailedAnalysis()">
                                <i class="fas fa-microscope me-1"></i>Deep Analysis
                            </button>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Details Modal -->
<div class="modal fade" id="detailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-info-circle me-2"></i>Detailed Analysis Results
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <h6 class="fw-bold text-primary mb-3">Input Features Analysis:</h6>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Feature</th>
                                <th>Value</th>
                                <th>Impact</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for feature, value in features.items() %}
                            <tr>
                                <td><code>{{ feature }}</code></td>
                                <td>{{ value }}</td>
                                <td>
                                    {% if prediction != 'Normal' and (
                                        (feature == 'src_bytes' and value == 0) or
                                        (feature == 'dst_bytes' and value == 0) or
                                        (feature == 'duration' and value == 0) or
                                        (feature == 'num_failed_logins' and value > 0)
                                    ) %}
                                        <span class="badge bg-danger">High</span>
                                    {% elif feature in ['protocol_type', 'service', 'flag'] %}
                                        <span class="badge bg-warning">Medium</span>
                                    {% else %}
                                        <span class="badge bg-success">Low</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <h6 class="fw-bold text-success mt-4 mb-3">Model Decision Process:</h6>
                <div class="alert alert-info">
                    <i class="fas fa-cogs me-2"></i>
                    The model analyzed {{ features|length }} features using an ensemble of machine learning algorithms 
                    including Random Forest, XGBoost, and Neural Networks to reach this conclusion with 
                    {{ confidence }}% confidence.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="exportDetails()">
                    <i class="fas fa-download me-2"></i>Export Details
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Create confidence chart
    const ctx = document.getElementById('confidenceChart').getContext('2d');
    const confidence = {{ confidence }};
    
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            datasets: [{
                data: [confidence, 100 - confidence],
                backgroundColor: ['#28a745', '#e9ecef'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            cutout: '70%',
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
    
    // Add confidence text in center
    const chartContainer = document.getElementById('confidenceChart').parentElement;
    chartContainer.style.position = 'relative';
    
    const centerText = document.createElement('div');
    centerText.style.position = 'absolute';
    centerText.style.top = '50%';
    centerText.style.left = '50%';
    centerText.style.transform = 'translate(-50%, -50%)';
    centerText.style.textAlign = 'center';
    centerText.innerHTML = `
        <div class="fw-bold text-primary" style="font-size: 1.5rem;">${confidence}%</div>
        <small class="text-muted">Confidence</small>
    `;
    chartContainer.appendChild(centerText);
    
    // Animate result card
    const resultCard = document.querySelector('.prediction-normal, .prediction-attack');
    if (resultCard) {
        resultCard.style.opacity = '0';
        resultCard.style.transform = 'scale(0.9)';
        resultCard.style.transition = 'all 0.8s ease';
        
        setTimeout(() => {
            resultCard.style.opacity = '1';
            resultCard.style.transform = 'scale(1)';
        }, 200);
    }
});

// Action functions
function generateReport() {
    const prediction = '{{ prediction }}';
    const confidence = '{{ confidence }}';
    
    // Simulate report generation
    const btn = event.target;
    const originalHTML = btn.innerHTML;
    btn.innerHTML = '<div class="loading me-2"></div>Generating...';
    btn.disabled = true;
    
    setTimeout(() => {
        alert(`Security Report Generated!\n\nResult: ${prediction}\nConfidence: ${confidence}%\n\nReport downloaded successfully.`);
        btn.innerHTML = originalHTML;
        btn.disabled = false;
    }, 2000);
}

function alertTeam() {
    alert('üö® Security team has been notified!\n\nAlert sent to:\n- Security Operations Center\n- Network Administrators\n- Incident Response Team');
}

function blockTraffic() {
    alert('üõ°Ô∏è Traffic blocking initiated!\n\nActions taken:\n- Source IP added to blacklist\n- Firewall rules updated\n- Traffic monitoring increased');
}

function detailedAnalysis() {
    alert('üî¨ Deep analysis scheduled!\n\nAnalysis includes:\n- Packet-level inspection\n- Behavioral analysis\n- Historical pattern matching');
}

function scheduleMonitoring() {
    alert('üìÖ Monitoring scheduled!\n\nConfiguration:\n- Continuous traffic analysis\n- Hourly security scans\n- Automated threat detection');
}

function shareResults() {
    if (navigator.share) {
        navigator.share({
            title: 'Network Security Analysis Results',
            text: 'Network traffic analysis completed - {{ prediction }} detected with {{ confidence }}% confidence.',
            url: window.location.href
        });
    } else {
        alert('üìä Results shared!\n\nShared with:\n- Security team dashboard\n- Network monitoring system\n- Compliance reporting');
    }
}

function exportDetails() {
    const details = {
        prediction: '{{ prediction }}',
        confidence: '{{ confidence }}',
        features: {{ features|tojson }},
        timestamp: new Date().toISOString()
    };
    
    const blob = new Blob([JSON.stringify(details, null, 2)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'security-analysis-details.json';
    a.click();
    URL.revokeObjectURL(url);
}
</script>
{% endblock %}